@model bool
@{
    Layout = "_layout";

}
<link href="/lib/jquery-ui/dist/css/jquery-ui.min.css" rel="stylesheet" />
<style>
    .contact-page .theme-form {
        padding: 20px;
        background-color: #f1f4f7;
        border: 0px solid #ffffff;
        margin-bottom: 20px;
    }

    .box {
        background-color: #fff;
        border-radius: 8px;
        border: 2px solid #e9ebef;
        padding: 20px;
        margin-bottom: 20px;
    }

    .box-title {
        margin-bottom: 10px;
        text-transform: uppercase;
        font-size: 16px;
        font-weight: 700;
        color: #094bde;
        letter-spacing: 2px;
    }

    .plan-selection {
        border-bottom: 2px solid #e9ebef;
        padding-bottom: 25px;
        margin-bottom: 35px;
    }

        .plan-selection:last-child {
            border-bottom: 0px;
            margin-bottom: 0px;
            padding-bottom: 0px;
        }

    .plan-data {
        position: relative;
    }

        .plan-data label {
            font-size: 20px;
            margin-bottom: 15px;
            font-weight: 400;
        }

    .plan-text {
        padding-left: 15px;
    }

    .plan-price {
        position: absolute;
        right: 0px;
        color: #094bde;
        font-size: 20px;
        font-weight: 700;
        top: 0;
    }

    /*
                                                    * SVG Icons
                                                    **********************************************************/
    .svg {
        display: block;
        position: absolute;
        top: 2px;
        right: 15px;
        width: 45px;
        height: 45px;
    }

    /*
                                                    * Buttons
                                                    **********************************************************/
    .button {
        position: relative;
        height: 50px;
        padding: 10px 20px;
        font-size: 14px;
        line-height: 48px;
        border-bottom: 1px solid #bbb;
        background: #fafafa;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .contact-page .theme-form input {
        padding: 8px 20px;
        margin-bottom: 0px;
    }

    .button:hover {
        background: #f5f5f5;
    }


    .button img {
        width: 30px;
        height: 30px;
    }

    @@media all and (min-width: 500px) {
        .svg {
            right: 25px;
            width: 55px;
            height: 55px;
        }

        .button {
            height: 60px;
            padding: 10px 20px;
            font-size: 16px;
            line-height: 58px;
        }

            .button img {
                width: 40px;
                height: 40px;
            }
        /*.button:after {
                                            top: 20px;
                                            left: 23px;
                                        }*/
    }
    /*
                                                    * Breakpoint
                                                    **********************************************************/
    @@media all and (min-width: 700px) {
        .svg {
            top: auto !important;
            right: 0 !important;
            left: 0;
            margin: auto;
            bottom: 10px;
            width: 60px;
            height: 60px;
        }



        .payments {
            max-width: 700px;
            margin: 0 auto;
            padding: 0px;
            overflow: hidden;
            display: flex;
        }

        .button {
            width: 150px;
            height: 150px;
            margin-right: 10px;
            padding: 20px 0;
            font-size: 18px;
            line-height: 1;
            text-align: center;
            border: 0;
            border-radius: 3px;
            box-shadow: inset 0 0 0 1px #bbb;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

            .button img {
                width: 60px;
                height: 60px;
            }

            .button:last-child {
                margin-right: 0;
            }
        /*.button:after {
                                            top: 15px;
                                            left: 55px;
                                        }*/
    }</style>

<!-- section start -->
<section class="section-big-py-space b-g-light pt-4">
    <div class="custom-container">
        <div class="checkout-page contact-page">
            <div class="checkout-form" id="checkoutSection">
                <div class="row">
                    <div class="col-lg-6 col-sm-12 col-xs-12" id="dbAddress">
                    </div>
                    <div class="col-lg-6 col-sm-12 col-xs-12" id="dvPlaceOrderDetails">
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
@section scripts{
    <script>
        window.addEventListener("storage", e => {
            let result = $.parseJSON(event.newValue);
            if (result.hasOwnProperty("origin")) {
                if (result.origin === 'addMoney') {
                    let paymentPendings = ['', '0', '1', 'pending', 'p'];
                    let isPending = paymentPendings.includes(result.paymentStatus?.toString().toLowerCase());
                    let iconSrc = `/Image/iconMsg/${isPending ? '10' : (result.paymentStatus == 'success' ? '1' : '11')}.png`;
                    let h3Class = `${isPending ? 'text-info' : (result.paymentStatus == 'success' ? 'text-success' : 'text-danger')}`;
                    let statusText = `${isPending ? 'Transaction Pending' : (result.paymentStatus == 'success' ? 'Transaction Successful' : 'Transaction Failed')}`;
                    let _html = `<div class="row">
                                   <div class="col-sm-12 text-center">
                                     <img src="${iconSrc}" />
                                     <h3 class="${h3Class}">${statusText}<br/>
                                                <small>${result.statuscode == -1 ? result.paymentStatus : ''}</small>
                                      </h3>
                                   </div>
                                 </div>`;
                    Q.alert({
                        title: 'Transaction Status',
                        body: _html,
                        width: 600,
                        onClose: function () {
                            if (result?.paymentStatus == 'success') {
                                window.location.href = "/UserOrderHistory";
                            }
                        }
                    });
                }
            }
        }, true);


        $(document).ready(function () {
            loadAddressDetails();
            const buynow = '@Model';
            loadPlaceOrderCart(buynow.toLowerCase() === 'true' ? true : false);
        });
        const loadAddressDetails = async function () {
            await $.post("/GetUserAddress").done(res => {
                $('#dbAddress').html(res);
                $('#dvshowaddress').removeClass('d-none');
            }).fail(xhr => Q.xhrError(xhr)).always(() => "");
        }
        const loadPlaceOrderCart = async function (IsBuyNow = false) {
            await $.post("/_CartPlaceOrder", { IsBuyNow: IsBuyNow }).done(res => {
                $('#dvPlaceOrderDetails').html(res);
                loadpaymentmode();
            }).fail(xhr => Q.xhrError(xhr)).always(() => "");
        }
        $(document).on('click', '#btnPlaceOrder', (e) => {
            const url = new URL(window.location);
            const isbuynow = url.pathname.replace('/checkout/', '');

            let _parent = $(e.currentTarget).parents('#checkoutSection');
            let item = {
                AddressID: _parent.find('[name="address"]:checked').data().addressId,
                PaymentMode: _parent.find('[name="paymentMode"]:checked').data().paymentMode,
                IsBuyNow: isbuynow?.toLowerCase(),
                Remark: ""
            };
            $.post("/PlaceOrder", item).done(res => {
                if (typeof res === 'object') {
                    if (res.statusCode != 1) {
                        Q.notify(res.statusCode, res.responseText)
                    }
                    else {
                        Q.notify(res.statusCode, res.responseText)
                        setTimeout(
                            function () {
                                window.location.href = '/UserOrderHistory';
                            }, 2000);

                    }
                }
                else {
                    var myWindow = window.open("", "_blank", "toolbar=0 width=650px,height=650px");
                    myWindow.document.write(res);

                }
            }).fail(xhr => Q.xhrError(xhr)).always(() => "");
        });
        var loadStateDDL = (selector) => {
            $.post(baseURL + "/State/GetStateDDL").done(function (result) {
                console.log('State result :', result);
                if (selector) {
                    $(selector).html(`<option value=""> Select State </option>`).append(result.map(x => { return `<option value="${x.id}"> ${x.stateName} </option>` }))
                }
            }).fail(function (xhr) {
                console.log(xhr.responseText);
                alert('something went wrong');
            })
        }
        var loadpaymentmode = () => {
            $.post("/GetPaymentMode", { IsCod: $('#IsCod').is(':checked') }).done(res => {
                $.each(res.result, async function (i, v) {
                    let current = i == 0 ? "checked" : "";
                    $('#dvPaymentModes').append(`<div class='button '>
                               <input type="radio" name="paymentMode" data-payment-Mode="${v.id}" ${current}>
                                               ${v.name}

                                                <img src="${v.icon}" />
                                            </div>`);
                });
            }).fail(xhr => Q.xhrError(xhr)).always(() => "");
        }
    </script>
}

<!-- section end -->